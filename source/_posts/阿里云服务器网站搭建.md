---
title: 阿里云服务器网站搭建
date: 2023-05-07
---

# 一. 前言

大家都知道，LAMP 是搭建 Web 服务一个比较经典的结构。分别是 L（Linux）、A（Apache）、M（MySQL）、P（PHP）。

但由于目前我所有的都是静态的网站，所以后面的两个（MySQL 和 PHP）都无法进行演示，所以如果想要在服务器上使用 MySQL 和 PHP 的教程的朋友可以去找一找其他的教程。

****

我所选择的用于演示的服务器是阿里云的一个 ECS 云服务器，地址在香港，所以不用备案域名就可以直接解析到该服务器。

我所选择的服务器的系统是阿里巴巴针对云服务器所定制的一个 Linux 系统，版本号是：Alibaba Cloud Linux 3.2104 LTS 64位

如果你选用其他的系统，可能在下面介绍的一些细节的操作上存在一些区别，请自行判断。

****

另外，由于这篇文章基本上是以我自己的几个网站作为案例写下来的，所以肯定不可能适合所有人，所以如果发现我的例子不太适合你的情况，如果不太确定自己应该怎么做，请一定去找更准确的教程。

****

接下来，就让我们开始吧！



# 二. 前期准备

## 1. 添加 80 端口访问

购买好服务器后，我们需要首先来到 **ECS控制台**的**安全组部分**：

![01](images/阿里云服务器网站搭建/01.png)

我们点击红框标出来的**配置规则**，然后进入到下面的界面：

![02](images/阿里云服务器网站搭建/02.png)

直接选择快速添加，将 80 端口添加即可。



## 2. 连接服务器

要连接到阿里云的服务器有两种方法，一种是直接通过阿里云提供的网络工具连接，另一种是直接从系统使用 ssh 连接。我们先介绍后者吧。

### 1）使用本地 ssh 连接到服务器

**基本使用**：

现在不管是 Windows 还是 Linux 几乎都已经内置了 ssh 工具，可以直接从命令行使用 ssh 命令连接，如：

```bash
ssh User@HostName
```

即可连接到我们的服务器，接下来输入密码进入即可。在上面的命令中，`User`就是你将要登陆的服务器的用户名，而`HostName`就是你的服务器主机名，也就是阿里云给你的服务器的公网 IP，具体的使用如下：

![03](images/阿里云服务器网站搭建/03.png)

其中`root`就是我要登录的用户名，而后面的 IP 地址就是主机名。

回车之后，首先会询问你是否继续连接，我们选择`yes`。接着就会问你该服务器下登录用户的密码，这里输入之后并不会出现任何可视字符，不用担心你没有输进去。

然后回车我们就进入了该服务器。

****

**设置 ssh 密钥对**：

每一次登录服务器都需要输入密码，这是理所当然的，但如果有一种不用输入密码也能保证安全的方法，那肯定更好。刚好 ssh 就有这样的功能。

我们首先执行下面的命令：

```bash
ssh-keygen -t rsa -b 4096 -C "Name"
```

其中`"Name"`的部分随你喜好填写一个可以标识你身份或你的电脑的名字就行了。

执行命令之后，它会问你是否修改保存密钥文件的地址，我们默认就行。然后它会让你输入密码，但是这个密码我们可以不输入，即为空，然后确认密码即可。

然后，我们就能在当前用户文件夹下的`.ssh`文件夹下找到两个文件，一个是`id_rsa`，一个是`id_rsa.pub`。其中，前者是你电脑的私钥，不能给别人的，而后者是你电脑的公钥，把它交给你想要连接的远程主机即可实现使用密钥对连接而不需要输入密码。

将公钥交给远程主机的具体行为是将公钥的内容写入到远程主机的`.ssh/authorized_keys`文件中，实现该操作的方法在 Linux 和 Windows 下又有不同：

- Linux

  我们直接执行下面的命令即可：

  ```bash
  ssh-copy-id User@HostName
  ```

  它会自动将你的公钥添加到远程主机的`authorized_keys`文件中。

- Windows

  由于在 Windows 中并没有`ssh-copy-id`命令，所以我们需要使用一些其他的方法，这里只介绍其中一种。

  首先我们执行下面的命令将公钥文件传输到远程主机：

  ```bash
  scp C:\Users\YourName\.ssh\id_rsa.pub User@HostName:~/
  ```

  其中`C:\Users\YourName\`就是你的用户文件夹，把`YourName`改为你的用户名即可。

  然后先连接到你的远程主机：

  ```bash
  ssh User@HostName
  ```

  然后再将刚刚传输过去的文件的内容写入到`authorized_keys`文件中即可：

  ```bash
  cat id_rsa.pub >> .ssh/authorized_keys
  ```

  操作完成后删除我们之前传输的文件：

  ```bash
  rm id_rsa.pub
  ```

  然后就 OK 了。

之后我们再从本地连接到服务器就不需要输入密码了。

****

**设置别名**：

如果每一次登录都需要输入登录用户和主机名的话还是会比较麻烦，我们可以通过下面的方法来为服务器设置别名。

首先进入到我们刚刚创建密钥所在的`.ssh`文件夹中，新建一个`config`文件，注意没有任何后缀名。

然后我们往`config`里添加以下内容：

```
Host Alias
	HostName 127.0.0.1
	User root
```

其中`Alias`就是你的服务器的别名，然后在下面`HostName`后填上你的服务器的主机名即可（就是公网 IP，我这里填了一个 localhost 的地址代替），最后是`User`的值就是你要登陆的用户名。

在这样设置完成之后就可以使用下面的命令直接进入服务器了：

```bash
ssh Alias
```



### 2）阿里云网络工具连接服务器

我们进入到 **ECS控制台** 并进入到实例管理页面，然后直接点击**远程连接**按钮即可：

![04](images/阿里云服务器网站搭建/04.png)

在弹出的窗口里直接选择**立即登录**即可：

![05](images/阿里云服务器网站搭建/05.png)

然后就可以输入密码登陆了。

由于我的服务器地址在香港，本地 ssh 连接会容易断线，所以后续的演示我们将使用该方法连接服务器。



# 三. 安装使用 Apache

## 1. 安装

直接使用下面的命令安装即可：

```bash
yum install httpd
```

实际上 Apache 的本名叫 httpd，我们后面的命令也将使用 httpd



## 2. 重要目录

安装好 Apache 之后，有两个比较重要的目录，我们后续的操作基本上都涉及这两个目录：

一个是：`/etc/httpd/`，在这个目录下，主要包括`conf`目录、`conf.d`目录以及`conf.modules.d`目录。在`conf`目录下的`httpd.conf`文件是 Apache 的主要配置文件，当我们运行 httpd 命令时，它就会读取该配置文件。

而`conf.d`目录下的配置文件可以用于补充`httpd.conf`，但如果在`httpd.conf`文件中包含了这些文件，就相当于把这些子配置文件的内容写入到`httpd.conf`文件中。对于`conf.modules.d`目录下的配置文件也是一样。

在功能上，`conf.d`的配置文件主要用于补充`httpd.conf`的配置，而`conf.modules.d`下的配置文件主要用于添加某个模块。

第二个目录是：`/var/www`，在这个目录下是 Apache 默认保存网页文件的地方，它有一个叫做`html`的目录，你可以把自己的网站文件全部放在这里面，运行 Apache 就直接能访问你的网页了。但我们之后会通过 Git 来拉取仓库，所以不用这个文件夹。

## 3. 认识 Apache 的配置文件

我们用 vim 打开`httpd.conf`文件，可以看到里面有下面这些比较主要的内容：

![06](images/阿里云服务器网站搭建/06.png)

这就是我们刚刚所说的最重要的其中一个目录，它表示服务器将从这个目录下读取配置文件。

![07](images/阿里云服务器网站搭建/07.png)

这个配置表示使用 Apache 监听 80 端口，也就是 http 协议的默认端口，我们所有通过域名访问的操作都将默认使用 80 端口访问服务器。

![08](images/阿里云服务器网站搭建/08.png)

这一行内容表示将包含所有`conf.modules.d`目录下的所有`.conf`配置文件，其效果就跟我们刚刚所说的一样。

![09](images/阿里云服务器网站搭建/09.png)

可以看到这一行配置默认是被注释掉了的，它用来配置我们访问并解析到该服务器的域名。

![10](images/阿里云服务器网站搭建/10.png)

这一段内容就是用来指示网页文件的位置以及权限的了，其中`DocumentRoot`后面的路径表示网站主页文件所在的位置，一般是`index.html`所在的位置。

`<Directory "/var/www">`标签对以及其中的内容用来定义该目录下服务器所拥有的权限。

`<Directory "/var/www/html"`标签对就是用来定义你的网站主页文件所在目录的权限了。

![11](images/阿里云服务器网站搭建/11.png)

这一条配置是用来描述 Apache 默认查找哪个文件作为网站的主页文件的，你可以在`index.html`后面添加一个如`test.html`，它所实现的效果就是如果在你所指定的`DocumentRoot`下找不到`index.html`文件的话，就寻找`test.html`文件作为网站的主页



# 四. 搭建网站

认识了最基本的 Apache 配置之后，我们开始搭建网站。在修改各种配置之前我们先将网页文件拉下来以及配置好相应的环境。

我这里有三个网站，他们的仓库名分别是：`Syunn`、`Blog`、`Note`。我们首先演示只搭建一个网站的配置方法，用`Syunn`作为示例。然后我们将演示搭建多个网站的配置方法，此时三个仓库都将作为示例。

其中`Blog`是用`hexo`进行构建的，所以我们除了`git`之外还需要`hexo`，当然要运行和下载`hexo`，那也少不了`nodejs`和`npm`。

## 1. 准备

### 1）git

安装 git 很简单：`yum install git`即可

然后就是配置`ssh`密钥和`git`配置：

通过下面的命令创建密钥对：

```bash
ssh-keygen -t rsa -C "Server"
```

然后通过`vim`打开`id_rsa.pub`文件，复制其中的内容。然后打开`github`网站的`setting`下的`SSH and GPG keys`处，点击新建 SSH key，取好名字，将复制的内容填入下面的文本框即可。

然后使用下面的命令测试一下 ssh 连接：

```bash
ssh -T git@github.com
```

如果正常说明已经能够正常连接。

最后配置一下`git`即可完成`git`的安装了：

```bash
git config --global user.name "<你的用户名>"
git config --global user.email "<你的邮箱>"
git config --global core.quotepath false		/* 解决中文路径显示乱码的问题 */
```

当然，这些配置写不写都无所谓，因为在服务器这个不太适合编程的环境下，我们通常只需要进行`git pull`操作。



### 2）nodejs

安装`nodejs`同样：`yum install nodejs`

然后测试一下：

```bash
node -v
npm -v
```

如果都正常显示版本号，则安装成功

因为是在服务器上使用`npm`，所以实际上换不换源都无所谓，阿里云提供的服务器下行速度都还是又稳又快。

然后安装我需要的`hexo`即可：

```bash
npm install hexo-cli -g
```

测试一下：

```bash
hexo -v
```

正常显示即可。



## 2. 单网站搭建

### 1）准备

我们首先通过`git`将`Syunn`文件夹拉取到`/var/www/`目录下；



### 2）修改配置文件

将原本的`httpd.conf`文件做一个备份，以便日后恢复：`cp /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.backup`

然后我们通过`vim`打开`httpd.conf`文件：`vim /etc/httpd/conf/httpd.conf`

在我们之前介绍的配置文件内容的基础上，我们需要修改的内容有以下几点：

```bash
# 修改域名
ServerName syunn.cn

# 修改网站根目录
DocumentRoot "/var/www/Syunn"

# 以及网站根目录的权限处同样也要修改
# 原来是 <Directory "/var/www/html">
<Directory "/var/www/Syunn">
	# 中间内容不变
</Directory>
```

就这么简单就 OK 了。



### 3）运行 Apache

```bash
httpd -k start
```

在运行之前实际上要先去将自己的域名解析到这个 IP 地址，才可以通过域名访问，我已经提前弄好了，直接就可以看到效果了：

![12](images/阿里云服务器网站搭建/12.png)



## 3. 多网站搭建

### 1）准备

我希望我的博客能用子域名`blog.syunn.cn`访问以及我的笔记能用`note.syunn.cn`访问，而不是使用子目录的形式访问。

Apache 的虚拟主机功能为这个问题提供了很好的解决方案。

实际上这个功能用起来非常的简单，只需要往`httpd.conf`文件里添加几段内容即可。为了模块化该配置文件，我们可以将虚拟主机的功能配置写在其他配置文件中，然后用`httpd.conf`包含该文件即可。

在修改配置之前，我们先将此次演示需要的两个文件夹`Blog`和`Note`拉取到`/var/www`中即可，然后在`Blog`文件夹中执行`npm install`和`hexo g -d`命令即可完成网页文件的生成。



### 2）修改配置文件

首先我们在`conf.d`目录下添加一个新的配置文件，文件名随意取因为那并不是决定性因素，我们就暂定为`virtual.conf`。

然后通过`vim`打开该文件，添加下面的内容：

```bash
# 首先针对多出来的两个可浏览目录进行权限方面的规范，我们之前的 Syunn 那个目录在 httpd.conf 里已经配置过了
<Directory "/var/www/Blog/public">		# Blog 的网页文件生成在 public 子目录下
	AllowOverride None
	Order allow,deny
	Allow from all
</Directory>
<Directory "/var/www/Note">
	AllowOverride None
	Order allow,deny
	Allow from all
</Directory>

# 针对三台主机的 DocumentRoot 进行设置
<VirtualHost *:80>				# *:80 表示所有对该服务器的 80 端口访问
	ServerName syunn.cn
	ServerAlias www.syunn.cn		# 设置别名，我希望 www.syunn.cn 可以和使用 syunn.cn 达到同样的效果
	DocumentRoot /var/www/Syunn
</VirtualHost>
<VirtualHost *:80>
	ServerName blog.syunn.cn
	DocumentRoot /var/www/Blog/public
</VirtualHost>
<VirtualHost *:80>
	ServerName note.syunn.cn
	DocumentRoot /var/www/Note
</VirtualHost>
	
```

需要注意以下几点：

- 在虚拟主机的设置上还有很多可用的功能，不过，最低的限度是需要有`ServerName`和`DocumentRoot`这两个
- 在配置目录权限时使用到的配置项不做解释，请自行去查一查权威的用法
- 使用了虚拟主机后，原本的主机名（`syunn.cn`）也要同时写入虚拟主机的对应中，否则这个主机名可能会不知道被丢到哪里去

然后，我们需要在`httpd.conf`文件中包含该文件，可以选择只包含这一个文件，也可以包含`conf.d`这整个文件夹，我选择的是包含整个文件夹。

在实际的操作中，我选择将这个包含配置写在包含`conf.modules.d`目录的配置项下面，这样更加的清晰：

```bash
Include conf.modules.d/*.conf
# 第一行是原文件中有的
# 下面是我们添加的
Include conf.d/*.conf
```

在`httpd.conf`文件的末尾实际上还有一条：

```bash
IncludeOptional conf.d/*.conf
```

我们现在可以将它删掉了。



### 3）重启 Apache

这些都弄好之后我们就可以重启 Apache 了。

重启可以是直接使用`httpd -k restart`，也可以先停下来再启动，即：

```bash
httpd -k stop
httpd -k start
```

第一种操作当然更简单，但实际操作中我选择的是第二种，而且每种操作我都重复执行了一遍，为的就是要准确控制 Apache 的工作状态，因为这样的操作会让它有下面这样的输出：

![13](images/阿里云服务器网站搭建/13.png)

重启完成之后我们就可以使用三个域名分别打开三个网站了：

![14](images/阿里云服务器网站搭建/14.png)

![15](images/阿里云服务器网站搭建/15.png)



# 五. 使用 https

## 1. 前言

要使用 https 首先需要的一个东西就是 ssl 证书，这个证书说好拿也好拿，说不好拿也不好拿。

首先你可以自制一个自签名的证书，这很轻松，但不幸的是，经过多次测试这样的证书大部分浏览器都不认。

那么就只能去获取一个 CA 认证的证书了，但这些证书不是贵就是弄起来麻烦，所以在写这篇博客之前我一直都只使用`http`协议。

但在今天我找到了一个可以轻松白嫖且轻松搭建的方法。



## 2. 准备

### 1）购买证书

我们首先进入到阿里云的 ssl 证书购买界面：

![16](images/阿里云服务器网站搭建/16.png)

我们首先就直接叉掉这个购买页面，然后来到红框标注的**免费证书**这一栏：

![17](images/阿里云服务器网站搭建/17.png)

我们直接点击**立即购买**即可。需要注意的是免费证书一年只能购买 20 个，每个证书只能用于一个域名，不能用于泛域名（对我来说足够了）。另外这些证书有效期为 1 年，但是 1 年之后又可以重新免费购买（简直不要太爽）。



### 2）创建证书

我们购买好之后可以看见在刚刚的**立即购买**按钮旁边的**创建证书按钮**后面多了一个`20/20`，也就是我们还可以创建 20 个证书，我们直接点击创建。

需要注意的是创建后的 ssl 证书还需要申请 CA 认证以及域名绑定：

![18](images/阿里云服务器网站搭建/18.png)

我们点击**证书申请**即可，在申请页面需要填写绑定的域名（注意只能是单域名如`syunn.cn`、`blog.syunn.cn`，不能是泛域名如`*.syunn.cn`），然后一般首次申请还需要添加联系人，即申请完成后会通过该渠道发信息给你。最后还有一个所在地填写，正常填写即可。

最后点击**提交审核**然后等待审核完成就可以了，这个时间很快，一般两三分钟就可以了，已经审核的 ssl 证书如下所示：

![19](images/阿里云服务器网站搭建/19.png)

然后按照同样的操作为我们的三个域名都创建一个证书就可以了，其中`syunn.cn`只需要创建一个，因为默认该证书将同时用于`www.syunn.cn`。



### 3）添加 443 端口访问

创建好证书之后我们先不着急部署，我们先按照和添加 80 端口同样的方法将 443 端口的访问权限开通即可。

443 端口就是 https 协议的默认传输端口，这里我就不再介绍具体的过程了。



## 3. 部署 SSL 证书

阿里云提供的证书有一个一键部署的功能，但由于抽象程度比较高，操作者不太清楚其中做了什么，而且也容易出错，所以我们使用更具体的部署方法。

### 1）安装 mod_ssl

我们首先需要安装`mod_ssl`模块，Apache 才能启用 https 功能。

安装命令：`yum install mod_ssl`

安装好之后又多了几个比较重要的文件和目录，分别是：

- `/etc/httpd/conf.modules.d/00-ssl.conf`：该文件为 Apache 提供 ssl 模块功能，我们后面不会改动这个文件
- `/etc/httpd/conf.d/ssl.conf`：该文件为 ssl 功能的配置文件，我们主要修改这个文件
- `/etc/pki/tls/certs/`：该目录主要包含 ssl 的默认证书文件，我们的证书文件虽然不一定要在这个目录下，但为了统一起见，我们也将证书放在该目录下

****

**认识配置**：

在修改之前我们还是先认识一下`ssl.conf`配置文件里的内容：

![21](images/阿里云服务器网站搭建/21.png)

首先第一条配置就是先开启监听 443 端口。

![22](images/阿里云服务器网站搭建/22.png)

然后就是一个标签对，这个标签对里的内容也是我们等会重点修改的内容，同时在搭建另外两个网站时还会新建两个标签对，就和创建虚拟主机时的操作类似。

可以看到里面也有`DocumentRoot`和`ServerName`等内容，这些虽然看上去我们在`virtual.conf`配置文件里已经配置过了，但那是监听的 80 端口，而这是监听的 443 端口。也就是说，如果我们访问：`http://syunn.cn`就将进入`virtual.conf`这个配置文件，而如果访问：`https://syunn.cn`就将进入`ssl.conf`这个配置文件。



### 2）下载证书

在创建好的证书的后面有一个**下载**按钮，我们点击就会弹出下面的界面：

![20](images/阿里云服务器网站搭建/20.png)

由于我们是使用的 Apache 搭建的服务，所以我们选择下载 Apache 的证书。

同时在**下载**按钮前还有一个**帮助**按钮，这里提供了最新的部署方法，也是可以参考的。

点击**下载**之后它会将证书的压缩包下载到本地，我们可以将其先解压然后通过和把`id_rsa.pub`文件传输到服务器上一样的方法将解压出来的证书传输到服务器，也可以直接将压缩包通过该方法传输到服务器，然后在服务器上安装`zip`工具通过`unzip`命令解压压缩包即可。安装命令：`yum install zip`

由于一个域名将有多个证书文件，所以我的建议是在`/etc/pki/tls/certs/`目录下按照域名来建立相应的子目录，将对应的证书内容放在对应的子目录下，这样不容易产生混乱。



### 3）修改配置文件

以配置`syunn.cn`为例，我们首先通过`vim`打开`/etc/httpd/conf.d/ssl.conf`文件，需要修改的有以下内容（有些配置项本身是被注释了的，直接删除`#`即可取消注释）：

```bash
# 首先将标签中的 _default_ 改为 *，如下所示：
<VirtualHost *:443>
	ServerName syunn.cn
	ServerAlias www.syunn.cn
	DocumentRoot /var/www/Syunn
	
	SSLEngine on
	
	SSLProtocol all -SSLv2 -SSLv3
	
	SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM
	SSLHonorCipherOrder on
	SSLCertificateFile /etc/pki/tls/certs/syunn/syunn.cn_public.crt		# 以_public.crt 结尾的那个文件
	SSLCertificateKeyFile /etc/pki/tls/certs/syunn/syunn.cn.key		# 以 .key 结尾的那个文件
	SSLCertificateChainFile /etc/pki/tls/certs/syunn/syunn.cn_chain.crt		# 以 _chain.crt 结尾的那个文件

	# 其他未涉及到的内容不做修改
</VirtualHost>
```

如果想要添加其他的域名，就添加一对`<VirtualHost *:443>`标签对然后在里面把上面所涉及到的内容添加到标签对里面即可。

**需要注意的是**，新添加的`VirtualHost`标签对一定要在前一个`VirtualHost`标签对之外，注意不要看错了，因为在默认的那个`VirtualHost`标签对中还有其他标签对。

大概的内容都已经涉及到了，这里就不再演示添加其他域名的操作了。

添加完成后还需要确认在`httpd.conf`文件中有没有包含这个文件，由于我们之前添加包含时直接添加了整个目录，所以可以确定是包含了的。



### 4）将 http 访问转发到 https

我们可以强制所有对网站的访问都是 https 访问。具体做法是修改之前的监听 80 端口的那个虚拟主机配置文件。

我们首先通过`vim`打开该文件，在这个文件里，我们设置了三个虚拟主机，分别代理三个域名，如果我们需要某个域名强制使用 https 访问，就在该虚拟主机的标签对里添加下面的内容：

```bash
RewriteEngine on
RewriteCond %{SERVER_PORT} !^443$
RewriteRule ^(.*)$ https://%{SERVER_NAME}$1 [L,R]
```

`Rewrite`是一个重写配置，它使用正则表达式进行配置，上面的配置的含义就是当监听到 http 访问时就转发到对应的 https 访问。



### 5）重启 Apache

按照之前的操作将 Apache 服务重启一次即可。

可以看到，在地址栏旁边已经不再是**“不安全”**的提示了，已经可以使用 https 访问了：

![23](images/阿里云服务器网站搭建/23.png)

![24](images/阿里云服务器网站搭建/24.png)

![25](images/阿里云服务器网站搭建/25.png)

